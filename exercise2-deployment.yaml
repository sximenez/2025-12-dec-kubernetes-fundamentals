apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapi
  namespace: kubernetes-fundamentals
spec:
  replicas: 3
  selector:
    matchLabels:
      app: myapi
  template:
    metadata:
      labels:
        app: myapi
    spec:
      containers:
      - name: api
        image: mcr.microsoft.com/dotnet/samples:aspnetapp
        ports:
        - containerPort: 8080
        
        # Environment variables from ConfigMap
        env:
        - name: LOG_LEVEL
          valueFrom:
            configMapKeyRef:
              name: kube-fundamentals-app-config
              key: LOG_LEVEL
        
        - name: FEATURE_FLAG_NEWUI
          valueFrom:
            configMapKeyRef:
              name: kube-fundamentals-app-config
              key: FEATURE_FLAG_NEWUI
        
        # Environment variables from Secret
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: kube-fundamentals-db-credentials
              key: password
        
        - name: CONNECTION_STRING
          valueFrom:
            secretKeyRef:
              name: kube-fundamentals-db-credentials
              key: connection-string
        
        # Mount entire ConfigMap as file
        # A configMap is just a data store: it doesn't automatically get injected into pods
        # To make values available, we need to mount the configMap as a volume or set env vars
        volumeMounts:
        - name: config-volume
          mountPath: /app/config
          readOnly: true
      
      volumes:
      - name: config-volume
        configMap:
          name: kube-fundamentals-app-config